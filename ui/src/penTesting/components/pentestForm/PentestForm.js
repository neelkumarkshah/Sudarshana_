import React, { useState, useContext, useEffect } from "react";
import { Form, Row, Col, Alert, FloatingLabel } from "react-bootstrap";
import InputGroup from "react-bootstrap/InputGroup";

import Card from "../../../shared/components/uiElements/card/Card";
import ButtonLayout from "../../../shared/components/uiElements/button/Button";
import { AuthContext } from "../../../shared/context/auth-context";
import classes from "./PentestForm.module.css";

const cssOverride = `
    @media (max-width: 576px) {
      .input-group-text {
        font-size: 0.7rem !important;
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      .input-group-text {
        font-size: 0.85rem !important;
      }
    }
  `;

const PenTestForm = ({ onScanResult, formEnabled, handleStartScan }) => {
  const auth = useContext(AuthContext);
  const [error, setError] = useState(null);
  const [isFormDisabled, setIsFormDisabled] = useState(!formEnabled);
  const [formFields, setFormFields] = useState({
    url: "",
    applicationName: "",
    scanType: "default",
  });

  useEffect(() => {
    setIsFormDisabled(!formEnabled);
  }, [formEnabled]);

  const startPenTestHandler = async (event) => {
    event.preventDefault();
    setError(null);
    onScanResult(null);

    if (
      !formFields.url ||
      !formFields.applicationName ||
      formFields.scanType === "default"
    ) {
      setError("All fields are required. Please fill out all the details.");
      return;
    }

    handleStartScan();

    try {
      const response = await fetch(
        `${process.env.REACT_APP_BACKEND_URL}/pentesting/startScan`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${auth.token}`,
          },
          body: JSON.stringify({
            url: formFields.url,
            applicationName: formFields.applicationName,
            scanType: formFields.scanType,
            userId: auth.userId,
          }),
        }
      );

      const responseData = await response.json();

      if (!response.ok) throw new Error(responseData.message || "Scan failed");

      onScanResult(responseData);
    } catch (err) {
      setError(err.message);
      onScanResult({ error: err.message });
    } finally {
      setIsFormDisabled(true);
    }
  };

  return (
    <>
      <style>{cssOverride}</style>
      <Card>
        <Row className="align-items-center">
          <Col sm={12} md={12} lg={12}>
            <Form onSubmit={startPenTestHandler}>
              <Form.Group>
                <Row>
                  <Col sm={12} md={12} lg={6}>
                    <InputGroup>
                      <InputGroup.Text id="basic-addon3">
                        http:// or https://example.com
                      </InputGroup.Text>
                      <Form.Control
                        id="basic-url"
                        className={classes.inputForm}
                        aria-describedby="basic-addon3"
                        type="text"
                        placeholder="Enter your URL here..."
                        value={formFields.url}
                        onChange={(e) =>
                          setFormFields({ ...formFields, url: e.target.value })
                        }
                        disabled={isFormDisabled}
                        required
                      />
                    </InputGroup>
                  </Col>

                  <Col sm={12} md={6} lg={3}>
                    <FloatingLabel
                      controlId="floatingInputGrid"
                      label="Application Name"
                      className={`${classes.applicationName}`}
                    >
                      <Form.Control
                        type="text"
                        placeholder="Application Name"
                        className={classes.inputForm}
                        value={formFields.applicationName}
                        onChange={(e) =>
                          setFormFields({
                            ...formFields,
                            applicationName: e.target.value,
                          })
                        }
                        disabled={isFormDisabled}
                        required
                      />
                    </FloatingLabel>
                  </Col>

                  <Col sm={12} md={6} lg={3}>
                    <FloatingLabel
                      controlId="floatingSelectGrid"
                      label="Type of Scan"
                      className={`${classes.typeScanBtn}`}
                    >
                      <Form.Select
                        aria-label="Type of Scan"
                        value={formFields.scanType}
                        className={classes.inputForm}
                        onChange={(e) =>
                          setFormFields({
                            ...formFields,
                            scanType: e.target.value,
                          })
                        }
                        disabled={isFormDisabled}
                        required
                      >
                        <option value="default">Select Scan Type</option>
                        <option value="Web Application">Web Application</option>
                        <option value="API">API</option>
                      </Form.Select>
                    </FloatingLabel>
                  </Col>
                </Row>

                <Row className="mt-3 justify-content-center">
                  <Col
                    sm={12}
                    md={12}
                    lg={12}
                    className="d-flex justify-content-center"
                  >
                    <ButtonLayout
                      type="submit"
                      className={classes.ScanBtn}
                      disabled={isFormDisabled}
                    >
                      Start Scan
                    </ButtonLayout>
                  </Col>
                </Row>
              </Form.Group>
            </Form>
          </Col>
        </Row>
        {error && (
          <Row className={classes.reportErrRow}>
            <Col sm={12} md={12} lg={12}>
              <Alert variant="danger" className="text-danger">
                {error}
              </Alert>
            </Col>
          </Row>
        )}
      </Card>
    </>
  );
};

export default PenTestForm;
